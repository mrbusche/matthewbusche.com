<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ICS Calendar Viewer</title>
		<!-- Tailwind CSS for styling -->
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			/* Custom styles to enhance the calendar */
			body {
				-webkit-font-smoothing: antialiased;
				-moz-osx-font-smoothing: grayscale;
			}
			/* Style for the file input button */
			.file-input-button {
				background-color: #4f46e5;
				color: white;
				padding: 0.5rem 1rem;
				border-radius: 0.375rem;
				cursor: pointer;
				transition: background-color 0.2s;
			}
			.file-input-button:hover {
				background-color: #4338ca;
			}
			.file-input-button input[type='file'] {
				display: none;
			}
		</style>
	</head>
	<body class="bg-gray-100 text-gray-800 antialiased">
		<div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
			<!-- Header Section -->
			<header class="text-center mb-8">
				<h1 class="text-3xl sm:text-4xl font-bold text-gray-900">ICS Calendar Viewer</h1>
				<p class="mt-2 text-lg text-gray-600">Upload or paste your .ics data to visualize your events.</p>
			</header>

			<!-- Input Section -->
			<div id="input-section" class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md mb-8">
				<div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
					<!-- File Upload Column -->
					<div class="flex flex-col justify-center">
						<label for="ics-file" class="block text-sm font-medium text-gray-700 mb-2">Option 1: Upload .ics File</label>
						<div class="flex items-center space-x-4">
							<label class="file-input-button">
								<span>Choose File</span>
								<input type="file" id="ics-file" accept=".ics" class="hidden" />
							</label>
							<span id="file-name" class="text-gray-500 truncate">No file chosen</span>
						</div>
						<!-- Add Load Default Events Button -->
						<button
							id="load-default-btn"
							class="mt-4 bg-indigo-500 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
						>
							Load Default Events
						</button>
					</div>
					<!-- Paste Text Column -->
					<div>
						<label for="ics-text" class="block text-sm font-medium text-gray-700 mb-2">Option 2: Paste ICS Text</label>
						<textarea
							id="ics-text"
							rows="4"
							class="w-full p-2 border border-gray-300 rounded-md focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
							placeholder="BEGIN:VCALENDAR..."
						></textarea>
						<button
							id="parse-text-btn"
							class="mt-2 w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors"
						>
							Parse Text
						</button>
					</div>
				</div>
				<p id="error-message" class="text-red-500 text-sm mt-4 text-center h-5"></p>
			</div>

			<!-- Calendar View Section - Initially Hidden -->
			<main id="calendar-view" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg hidden">
				<!-- Monthly calendars will be generated by JavaScript here -->
			</main>

			<!-- Event Modal - Initially Hidden -->
			<div id="event-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50">
				<div class="bg-white rounded-lg shadow-2xl w-full max-w-lg max-h-[80vh] overflow-y-auto">
					<div class="flex justify-between items-center p-4 border-b">
						<h3 id="modal-date" class="text-xl font-semibold">Events</h3>
						<button id="close-modal" class="p-2 rounded-full hover:bg-gray-200 transition-colors">
							<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
								<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
							</svg>
						</button>
					</div>
					<div id="modal-body" class="p-6">
						<!-- Event details will be injected here -->
					</div>
				</div>
			</div>
		</div>

		<script>
			document.addEventListener('DOMContentLoaded', () => {
				const fileInput = document.getElementById('ics-file');
				const fileNameDisplay = document.getElementById('file-name');
				const icsTextInput = document.getElementById('ics-text');
				const parseTextBtn = document.getElementById('parse-text-btn');
				const errorMessage = document.getElementById('error-message');
				const calendarView = document.getElementById('calendar-view');
				const eventModal = document.getElementById('event-modal');
				const modalDate = document.getElementById('modal-date');
				const modalBody = document.getElementById('modal-body');
				const closeModalBtn = document.getElementById('close-modal');
				const loadDefaultBtn = document.getElementById('load-default-btn');

				let events = [];

				// --- 1. File Handling & Parsing ---
				fileInput.addEventListener('change', (e) => {
					const file = e.target.files[0];
					if (!file) {
						fileNameDisplay.textContent = 'No file chosen';
						return;
					}
					if (!file.name.toLowerCase().endsWith('.ics')) {
						errorMessage.textContent = 'Please select a valid .ics file.';
						fileNameDisplay.textContent = 'Invalid file type';
						calendarView.classList.add('hidden');
						return;
					}

					fileNameDisplay.textContent = file.name;
					icsTextInput.value = ''; // Clear textarea if a file is chosen

					const reader = new FileReader();
					reader.onload = (event) => {
						processICSData(event.target.result);
					};
					reader.onerror = () => {
						errorMessage.textContent = 'Failed to read the file.';
					};
					reader.readAsText(file);
				});

				parseTextBtn.addEventListener('click', () => {
					const icsContent = icsTextInput.value;
					if (!icsContent.trim()) {
						errorMessage.textContent = 'Please paste some ICS content first.';
						return;
					}
					fileNameDisplay.textContent = 'Pasted content';
					processICSData(icsContent);
				});

				loadDefaultBtn.addEventListener('click', () => {
					fileNameDisplay.textContent = 'Loading default events...';
					errorMessage.textContent = '';
					fetch('/ics/ignition-show-choir.ics')
						.then((response) => {
							if (!response.ok) throw new Error('Failed to fetch default ICS file.');
							return response.text();
						})
						.then((data) => {
							processICSData(data);
							fileNameDisplay.textContent = 'Default events loaded';
						})
						.catch((err) => {
							errorMessage.textContent = 'Could not load default events.';
							fileNameDisplay.textContent = 'Error loading default events';
						});
				});

				function processICSData(icsString) {
					try {
						events = parseICS(icsString);
						if (events.length > 0) {
							events.sort((a, b) => a.start - b.start);
							calendarView.classList.remove('hidden');
							errorMessage.textContent = '';
							renderAllMonths();
						} else {
							errorMessage.textContent = 'No events found in the provided data.';
							calendarView.classList.add('hidden');
						}
					} catch (err) {
						errorMessage.textContent = 'Failed to parse the data. Is it valid ICS content?';
						console.error('Parsing error:', err);
						calendarView.classList.add('hidden');
					}
				}

				function parseICS(icsData) {
					const unfoldedData = icsData.replace(/\r\n\s/g, '').replace(/\n\s/g, '');
					const lines = unfoldedData.replace(/\r\n/g, '\n').split('\n');
					const parsedEvents = [];
					let currentEvent = null;

					lines.forEach((line) => {
						if (line.startsWith('BEGIN:VEVENT')) {
							currentEvent = {};
						} else if (line.startsWith('END:VEVENT')) {
							if (currentEvent && currentEvent.summary && currentEvent.start) {
								parsedEvents.push(currentEvent);
							}
							currentEvent = null;
						} else if (currentEvent) {
							const [key, ...valueParts] = line.split(':');
							const value = valueParts.join(':');

							if (key.startsWith('DTSTART')) {
								currentEvent.start = parseICalDate(value, key);
							} else if (key.startsWith('DTEND')) {
								currentEvent.end = parseICalDate(value, key);
							} else if (key === 'SUMMARY') {
								currentEvent.summary = value;
							} else if (key === 'DESCRIPTION') {
								currentEvent.description = value.replace(/\\n/g, '\n');
							} else if (key === 'LOCATION') {
								currentEvent.location = value;
							}
						}
					});
					return parsedEvents;
				}

				function parseICalDate(dateString, key) {
					const isAllDay = key.includes('VALUE=DATE') || !dateString.includes('T');
					const year = parseInt(dateString.substring(0, 4), 10);
					const month = parseInt(dateString.substring(4, 6), 10) - 1;
					const day = parseInt(dateString.substring(6, 8), 10);

					if (isAllDay) {
						return new Date(Date.UTC(year, month, day));
					} else {
						const hour = parseInt(dateString.substring(9, 11), 10);
						const minute = parseInt(dateString.substring(11, 13), 10);
						const second = parseInt(dateString.substring(13, 15), 10);

						if (dateString.endsWith('Z')) {
							return new Date(Date.UTC(year, month, day, hour, minute, second));
						}
						return new Date(year, month, day, hour, minute, second);
					}
				}

				// --- 2. Calendar Rendering ---
				function renderAllMonths() {
					calendarView.innerHTML = '';
					if (events.length === 0) return;

					const firstEventDate = events[0].start;
					const lastEventDate = events[events.length - 1].start;
					let loopDate = new Date(firstEventDate.getUTCFullYear(), firstEventDate.getUTCMonth(), 1);

					while (loopDate <= lastEventDate) {
						const monthContainer = document.createElement('div');
						monthContainer.className = 'mb-12';

						const monthHeader = document.createElement('h2');
						monthHeader.className = 'text-3xl font-bold mb-6 text-gray-800';
						monthHeader.textContent = loopDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
						monthContainer.appendChild(monthHeader);

						const dayHeadersRow = document.createElement('div');
						dayHeadersRow.className = 'grid grid-cols-7 gap-1 text-center font-semibold text-gray-500 mb-2';
						['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach((day) => {
							const headerCell = document.createElement('div');
							headerCell.textContent = day;
							dayHeadersRow.appendChild(headerCell);
						});
						monthContainer.appendChild(dayHeadersRow);

						const gridContainer = document.createElement('div');
						gridContainer.className = 'grid grid-cols-7 gap-1';
						renderMonthGrid(gridContainer, loopDate.getUTCFullYear(), loopDate.getUTCMonth());

						monthContainer.appendChild(gridContainer);
						calendarView.appendChild(monthContainer);

						loopDate.setMonth(loopDate.getMonth() + 1);
					}
				}

				function renderMonthGrid(gridContainer, year, month) {
					const firstDayOfMonth = new Date(year, month, 1);
					const lastDayOfMonth = new Date(year, month + 1, 0);
					const daysInMonth = lastDayOfMonth.getDate();
					const startDayOfWeek = firstDayOfMonth.getDay();

					for (let i = 0; i < startDayOfWeek; i++) {
						const cell = document.createElement('div');
						cell.className = 'p-2 bg-gray-50 rounded-md';
						gridContainer.appendChild(cell);
					}

					for (let day = 1; day <= daysInMonth; day++) {
						const cell = document.createElement('div');
						const cellDate = new Date(Date.UTC(year, month, day));

						let cellClasses = 'relative p-2 text-sm border border-gray-200 rounded-md min-h-[120px] flex flex-col items-start ';
						cellClasses += 'bg-white hover:bg-gray-50 transition-colors';

						const dayNumber = document.createElement('span');
						dayNumber.textContent = day;

						const today = new Date();
						if (year === today.getFullYear() && month === today.getMonth() && day === today.getDate()) {
							dayNumber.className = 'font-bold bg-indigo-600 text-white rounded-full w-6 h-6 flex items-center justify-center';
						} else {
							dayNumber.className = 'font-medium text-gray-700';
						}
						cell.appendChild(dayNumber);

						const dayEvents = getEventsForDay(cellDate);

						if (dayEvents.length > 0) {
							const eventsContainer = document.createElement('div');
							eventsContainer.className = 'mt-1 w-full space-y-1 overflow-hidden';

							dayEvents
								.sort((a, b) => a.start - b.start)
								.forEach((event) => {
									const eventEl = document.createElement('div');
									eventEl.className = 'p-1 bg-indigo-100 text-indigo-800 text-xs rounded truncate cursor-pointer hover:bg-indigo-200';
									eventEl.textContent = event.summary;
									eventsContainer.appendChild(eventEl);
								});

							cell.appendChild(eventsContainer);
							cell.classList.add('cursor-pointer');
							cell.addEventListener('click', () => showEventModal(cellDate, dayEvents));
						}

						cell.className = cellClasses;
						gridContainer.appendChild(cell);
					}
				}

				function getEventsForDay(date) {
					const year = date.getUTCFullYear();
					const month = date.getUTCMonth();
					const day = date.getUTCDate();

					return events.filter((event) => {
						const eventStartDate = event.start;
						return (
							eventStartDate.getUTCFullYear() === year && eventStartDate.getUTCMonth() === month && eventStartDate.getUTCDate() === day
						);
					});
				}

				// --- 3. UI Interactivity ---
				closeModalBtn.addEventListener('click', () => {
					eventModal.classList.add('hidden');
				});

				eventModal.addEventListener('click', (e) => {
					if (e.target === eventModal) {
						eventModal.classList.add('hidden');
					}
				});

				function showEventModal(date, dayEvents) {
					modalDate.textContent = date.toLocaleDateString('en-US', {
						timeZone: 'UTC',
						weekday: 'long',
						year: 'numeric',
						month: 'long',
						day: 'numeric',
					});
					modalBody.innerHTML = '';

					if (dayEvents.length === 0) {
						modalBody.innerHTML = '<p>No events for this day.</p>';
					} else {
						const eventList = document.createElement('ul');
						eventList.className = 'space-y-4';

						dayEvents
							.sort((a, b) => a.start - b.start)
							.forEach((event) => {
								const listItem = document.createElement('li');
								listItem.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200';

								let timeString = 'All Day';
								if (!event.start.toUTCString().includes('00:00:00 GMT')) {
									const startTime = event.start.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
									const endTime = event.end ? event.end.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
									timeString = endTime ? `${startTime} - ${endTime}` : startTime;
								}

								let eventHtml = `
                            <p class="font-semibold text-indigo-700">${event.summary || 'No Title'}</p>
                            <p class="text-sm text-gray-500">${timeString}</p>
                        `;

								if (event.location) {
									eventHtml += `<p class="mt-2 text-sm text-gray-600"><strong>Location:</strong> ${event.location}</p>`;
								}
								if (event.description) {
									eventHtml += `<p class="mt-2 text-sm text-gray-600 whitespace-pre-wrap"><strong>Description:</strong> ${event.description}</p>`;
								}

								listItem.innerHTML = eventHtml;
								eventList.appendChild(listItem);
							});
						modalBody.appendChild(eventList);
					}

					eventModal.classList.remove('hidden');
				}
			});
		</script>
	</body>
</html>
